<!-- Generated by SpecStory -->

# Supabase Auth Setup: TypeScript React Infrastructure Complete (2025-10-08 20:54:22Z)

<!-- Claude Code Session f91f94b6-3268-48cb-a55a-99ed6617bd41 (2025-10-08_20-54-22Z) -->

_**User**_

Analyze these staged git changes and output ONLY a single-line conventional commit message (type(scope): description). No explanations.
diff --git a/src/hooks/use-cloud-modes.ts b/src/hooks/use-cloud-modes.ts
index ba7fb4b..c62c3f3 100644
--- a/src/hooks/use-cloud-modes.ts
+++ b/src/hooks/use-cloud-modes.ts
@@ -17,6 +17,7 @@ import type {
   PaginatedResponse,
 } from '@/services/cloud-mode-service';
 import type { CustomMode } from '@/types/mode';
+import type { CloudModeMetadata } from '@/types/cloud-mode';
 
 // ============================================================================
 // SERVICE SINGLETON
@@ -177,28 +178,26 @@ export function useModeById(id: string) {
  * Creates a new mode in the database. The mode is initially private.
  * Requires authentication.
  *
- * @returns React Query mutation for creating modes
+ * @returns Object with saveMode async function and isLoading state
  *
  * @example
  * ```tsx
- * function SaveButton({ mode }: { mode: CustomMode }) {
- *   const saveMode = useSaveMode();
- *
- *   const handleSave = () => {
- *     saveMode.mutate(mode, {
- *       onSuccess: (savedMode) => {
- *         toast.success(`Mode "${savedMode.name}" saved!`);
- *         navigate(`/modes/${savedMode.id}`);
- *       },
- *       onError: (error) => {
- *         toast.error(`Failed to save: ${error.message}`);
- *       },
- *     });
+ * function SaveButton({ mode, metadata }: { mode: CustomMode; metadata: CloudModeMetadata }) {
+ *   const { saveMode, isLoading } = useSaveMode();
+ *
+ *   const handleSave = async () => {
+ *     try {
+ *       const savedMode = await saveMode({ mode, metadata });
+ *       toast.success(`Mode "${savedMode.name}" saved!`);
+ *       navigate(`/modes/${savedMode.id}`);
+ *     } catch (error) {
+ *       toast.error(`Failed to save: ${error.message}`);
+ *     }
  *   };
  *
  *   return (
- *     <button onClick={handleSave} disabled={saveMode.isPending}>
- *       {saveMode.isPending ? 'Saving...' : 'Save to Cloud'}
+ *     <button onClick={handleSave} disabled={isLoading}>
+ *       {isLoading ? 'Saving...' : 'Save to Cloud'}
  *     </button>
  *   );
  * }
@@ -207,7 +206,7 @@ export function useModeById(id: string) {
 export function useSaveMode() {
   const queryClient = useQueryClient();
 
-  return useMutation({
+  const mutation = useMutation({
     mutationFn: (mode: CustomMode) => cloudModeService.saveMode(mode),
     onSuccess: (savedMode) => {
       // Invalidate my modes list to show the new mode
@@ -217,6 +216,13 @@ export function useSaveMode() {
       queryClient.setQueryData(cloudModeKeys.detail(savedMode.id), savedMode);
     },
   });
+
+  return {
+    saveMode: async ({ mode }: { mode: CustomMode; metadata: CloudModeMetadata }): Promise<CloudMode> => {
+      return mutation.mutateAsync(mode);
+    },
+    isLoading: mutation.isPending,
+  };
 }
 
 /**
diff --git a/src/pages/Library.tsx b/src/pages/Library.tsx
index 9c5214b..2c3d0a0 100644
--- a/src/pages/Library.tsx
+++ b/src/pages/Library.tsx
@@ -84,17 +84,17 @@ const Library = () => {
 
   // Handle loading mode into editor
   const handleLoadMode = (mode: any) => {
-    navigate(`/editor?mode=${mode.id}`);
+    navigate(`/?mode=${mode.id}`);
   };
 
   // Handle editing mode
   const handleEditMode = (mode: any) => {
-    navigate(`/editor?mode=${mode.id}&edit=true`);
+    navigate(`/?mode=${mode.id}&edit=true`);
   };
 
   // Handle creating new mode
   const handleNewMode = () => {
-    navigate("/editor");
+    navigate("/");
   };
 
   // Authentication check
diff --git a/supabase/.temp/cli-latest b/supabase/.temp/cli-latest
new file mode 100644
index 0000000..6a40654
--- /dev/null
+++ b/supabase/.temp/cli-latest
@@ -0,0 +1 @@
+v2.48.3
\ No newline at end of file
diff --git a/supabase/.temp/gotrue-version b/supabase/.temp/gotrue-version
new file mode 100644
index 0000000..a7eb6e7
--- /dev/null
+++ b/supabase/.temp/gotrue-version
@@ -0,0 +1 @@
+v2.179.0
\ No newline at end of file
diff --git a/supabase/.temp/pooler-url b/supabase/.temp/pooler-url
new file mode 100644
index 0000000..7f4949c
--- /dev/null
+++ b/supabase/.temp/pooler-url
@@ -0,0 +1 @@
+postgresql://postgres.nmbzgmhttmeogwaxhqio:[YOUR-PASSWORD]@aws-1-us-west-1.pooler.supabase.com:6543/postgres
\ No newline at end of file
diff --git a/supabase/.temp/postgres-version b/supabase/.temp/postgres-version
new file mode 100644
index 0000000..4767691
--- /dev/null
+++ b/supabase/.temp/postgres-version
@@ -0,0 +1 @@
+17.6.1.014
\ No newline at end of file
diff --git a/supabase/.temp/project-ref b/supabase/.temp/project-ref
new file mode 100644
index 0000000..4deddb9
--- /dev/null
+++ b/supabase/.temp/project-ref
@@ -0,0 +1 @@
+nmbzgmhttmeogwaxhqio
\ No newline at end of file
diff --git a/supabase/.temp/rest-version b/supabase/.temp/rest-version
new file mode 100644
index 0000000..93c142b
--- /dev/null
+++ b/supabase/.temp/rest-version
@@ -0,0 +1 @@
+v13.0.5
\ No newline at end of file
diff --git a/supabase/.temp/storage-version b/supabase/.temp/storage-version
new file mode 100644
index 0000000..581d478
--- /dev/null
+++ b/supabase/.temp/storage-version
@@ -0,0 +1 @@
+fix-object-level
\ No newline at end of file
diff --git a/supabase/migrations/001_create_modes_table.sql b/supabase/migrations/001_create_modes_table.sql
new file mode 100644
index 0000000..5afd8b8
--- /dev/null
+++ b/supabase/migrations/001_create_modes_table.sql
@@ -0,0 +1,171 @@
+-- Migration: 001_create_modes_table.sql
+-- Description: Create core modes table with user ownership and engagement metrics
+-- Created: 2025-10-08
+
+-- Modes table (core storage for custom controller modes)
+CREATE TABLE IF NOT EXISTS modes (
+  -- Primary identification
+  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
+  author_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
+
+  -- Mode metadata
+  name VARCHAR(255) NOT NULL,
+  description TEXT,
+  version VARCHAR(20) NOT NULL DEFAULT '1.0.0',
+
+  -- Mode data (JSONB for flexibility and queryability)
+  controls JSONB NOT NULL DEFAULT '{}'::jsonb,
+
+  -- Visibility flags
+  is_public BOOLEAN NOT NULL DEFAULT false,
+  is_official BOOLEAN NOT NULL DEFAULT false,
+  is_featured BOOLEAN NOT NULL DEFAULT false,
+
+  -- Engagement metrics (denormalized for performance)
+  downloads INTEGER NOT NULL DEFAULT 0,
+  likes INTEGER NOT NULL DEFAULT 0,
+  views INTEGER NOT NULL DEFAULT 0,
+  fork_count INTEGER NOT NULL DEFAULT 0,
+  rating DECIMAL(3,2) DEFAULT 0,
+  rating_count INTEGER NOT NULL DEFAULT 0,
+
+  -- Discovery metadata
+  tags TEXT[] DEFAULT '{}',
+  category VARCHAR(100),
+  thumbnail TEXT, -- Base64 or URL (future: Supabase Storage)
+
+  -- Relationships
+  parent_mode_id UUID REFERENCES modes(id) ON DELETE SET NULL,
+
+  -- Timestamps
+  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
+  modified_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
+  published_at TIMESTAMPTZ,
+
+  -- Constraints
+  CONSTRAINT valid_rating CHECK (rating >= 0 AND rating <= 5),
+  CONSTRAINT valid_version CHECK (version ~ '^\d+\.\d+\.\d+$')
+);
+
+-- Add comment for documentation
+COMMENT ON TABLE modes IS 'Stores custom MIDI controller modes created by users';
+COMMENT ON COLUMN modes.controls IS 'JSONB object containing control mappings (knobs, faders, buttons)';
+COMMENT ON COLUMN modes.is_public IS 'Whether mode is visible in public catalog';
+COMMENT ON COLUMN modes.is_official IS 'Marks official/verified modes';
+COMMENT ON COLUMN modes.is_featured IS 'Featured modes shown prominently in UI';
+COMMENT ON COLUMN modes.parent_mode_id IS 'Reference to original mode if this is a fork';
+
+-- Mode versions table (version history tracking)
+CREATE TABLE IF NOT EXISTS mode_versions (
+  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
+  mode_id UUID NOT NULL REFERENCES modes(id) ON DELETE CASCADE,
+  version VARCHAR(20) NOT NULL,
+  changes TEXT,
+  controls JSONB NOT NULL,
+  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
+
+  UNIQUE(mode_id, version)
+);
+
+COMMENT ON TABLE mode_versions IS 'Tracks version history of mode changes';
+
+-- Categories table (predefined mode categories)
+CREATE TABLE IF NOT EXISTS categories (
+  id VARCHAR(100) PRIMARY KEY,
+  name VARCHAR(100) NOT NULL,
+  description TEXT,
+  icon VARCHAR(50),
+  display_order INTEGER NOT NULL DEFAULT 0,
+
+  UNIQUE(name)
+);
+
+COMMENT ON TABLE categories IS 'Predefined categories for organizing modes';
+
+-- Insert default categories
+INSERT INTO categories (id, name, description, display_order) VALUES
+  ('daw-control', 'DAW Control', 'Digital Audio Workstation control surfaces', 1),
+  ('live-performance', 'Live Performance', 'Setups for live shows and DJing', 2),
+  ('mixing-mastering', 'Mixing & Mastering', 'Studio mixing and mastering workflows', 3),
+  ('instrument-control', 'Instrument Control', 'Hardware synth and instrument mappings', 4),
+  ('genre-specific', 'Genre-Specific', 'Genre-optimized configurations', 5),
+  ('educational', 'Educational', 'Learning and tutorial modes', 6)
+ON CONFLICT (id) DO NOTHING;
+
+-- Trigger function to update modified_at timestamp
+CREATE OR REPLACE FUNCTION update_modified_at()
+RETURNS TRIGGER AS $$
+BEGIN
+  NEW.modified_at = NOW();
+  RETURN NEW;
+END;
+$$ LANGUAGE plpgsql;
+
+COMMENT ON FUNCTION update_modified_at() IS 'Automatically updates modified_at timestamp on row update';
+
+-- Apply trigger to modes table
+CREATE TRIGGER modes_modified_at
+  BEFORE UPDATE ON modes
+  FOR EACH ROW
+  EXECUTE FUNCTION update_modified_at();
+
+-- Database functions for atomic operations
+-- Function to increment likes atomically
+CREATE OR REPLACE FUNCTION increment_likes(mode_id UUID)
+RETURNS void AS $$
+BEGIN
+  UPDATE modes
+  SET likes = likes + 1
+  WHERE id = mode_id;
+END;
+$$ LANGUAGE plpgsql SECURITY DEFINER;
+
+COMMENT ON FUNCTION increment_likes(UUID) IS 'Atomically increments like count for a mode';
+
+-- Function to decrement likes atomically
+CREATE OR REPLACE FUNCTION decrement_likes(mode_id UUID)
+RETURNS void AS $$
+BEGIN
+  UPDATE modes
+  SET likes = GREATEST(likes - 1, 0)
+  WHERE id = mode_id;
+END;
+$$ LANGUAGE plpgsql SECURITY DEFINER;
+
+COMMENT ON FUNCTION decrement_likes(UUID) IS 'Atomically decrements like count for a mode (minimum 0)';
+
+-- Function to increment fork count atomically
+CREATE OR REPLACE FUNCTION increment_fork_count(mode_id UUID)
+RETURNS void AS $$
+BEGIN
+  UPDATE modes
+  SET fork_count = fork_count + 1
+  WHERE id = mode_id;
+END;
+$$ LANGUAGE plpgsql SECURITY DEFINER;
+
+COMMENT ON FUNCTION increment_fork_count(UUID) IS 'Atomically increments fork count when mode is forked';
+
+-- Function to increment views atomically
+CREATE OR REPLACE FUNCTION increment_views(mode_id UUID)
+RETURNS void AS $$
+BEGIN
+  UPDATE modes
+  SET views = views + 1
+  WHERE id = mode_id;
+END;
+$$ LANGUAGE plpgsql SECURITY DEFINER;
+
+COMMENT ON FUNCTION increment_views(UUID) IS 'Atomically increments view count for a mode';
+
+-- Function to increment downloads atomically
+CREATE OR REPLACE FUNCTION increment_downloads(mode_id UUID)
+RETURNS void AS $$
+BEGIN
+  UPDATE modes
+  SET downloads = downloads + 1
+  WHERE id = mode_id;
+END;
+$$ LANGUAGE plpgsql SECURITY DEFINER;
+
+COMMENT ON FUNCTION increment_downloads(UUID) IS 'Atomically increments download count for a mode';
diff --git a/supabase/migrations/002_create_engagement_tables.sql b/supabase/migrations/002_create_engagement_tables.sql
new file mode 100644
index 0000000..2f6926c
--- /dev/null
+++ b/supabase/migrations/002_create_engagement_tables.sql
@@ -0,0 +1,69 @@
+-- Migration: 002_create_engagement_tables.sql
+-- Description: Create engagement tables for likes, ratings, and related functionality
+-- Created: 2025-10-08
+
+-- Mode likes table (many-to-many relationship)
+CREATE TABLE IF NOT EXISTS mode_likes (
+  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
+  mode_id UUID NOT NULL REFERENCES modes(id) ON DELETE CASCADE,
+  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
+
+  PRIMARY KEY (user_id, mode_id)
+);
+
+COMMENT ON TABLE mode_likes IS 'Tracks which users have liked which modes';
+COMMENT ON COLUMN mode_likes.user_id IS 'User who liked the mode';
+COMMENT ON COLUMN mode_likes.mode_id IS 'Mode that was liked';
+
+-- Mode ratings table (one rating per user per mode)
+CREATE TABLE IF NOT EXISTS mode_ratings (
+  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
+  mode_id UUID NOT NULL REFERENCES modes(id) ON DELETE CASCADE,
+  rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5),
+  review TEXT,
+  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
+  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
+
+  PRIMARY KEY (user_id, mode_id)
+);
+
+COMMENT ON TABLE mode_ratings IS 'Stores user ratings and reviews for modes';
+COMMENT ON COLUMN mode_ratings.rating IS 'Rating from 1-5 stars';
+COMMENT ON COLUMN mode_ratings.review IS 'Optional text review';
+
+-- Trigger for updated_at on mode_ratings
+CREATE TRIGGER mode_ratings_updated_at
+  BEFORE UPDATE ON mode_ratings
+  FOR EACH ROW
+  EXECUTE FUNCTION update_modified_at();
+
+-- Function to update mode rating aggregate (maintains denormalized data)
+CREATE OR REPLACE FUNCTION update_mode_rating()
+RETURNS TRIGGER AS $$
+BEGIN
+  -- Handle both INSERT/UPDATE and DELETE operations
+  IF TG_OP = 'DELETE' THEN
+    UPDATE modes
+    SET
+      rating = COALESCE((SELECT AVG(rating)::DECIMAL(3,2) FROM mode_ratings WHERE mode_id = OLD.mode_id), 0),
+      rating_count = (SELECT COUNT(*) FROM mode_ratings WHERE mode_id = OLD.mode_id)
+    WHERE id = OLD.mode_id;
+    RETURN OLD;
+  ELSE
+    UPDATE modes
+    SET
+      rating = COALESCE((SELECT AVG(rating)::DECIMAL(3,2) FROM mode_ratings WHERE mode_id = NEW.mode_id), 0),
+      rating_count = (SELECT COUNT(*) FROM mode_ratings WHERE mode_id = NEW.mode_id)
+    WHERE id = NEW.mode_id;
+    RETURN NEW;
+  END IF;
+END;
+$$ LANGUAGE plpgsql;
+
+COMMENT ON FUNCTION update_mode_rating() IS 'Automatically updates aggregate rating and count on modes table';
+
+-- Trigger to update mode rating aggregate after any change to mode_ratings
+CREATE TRIGGER mode_ratings_update_aggregate
+  AFTER INSERT OR UPDATE OR DELETE ON mode_ratings
+  FOR EACH ROW
+  EXECUTE FUNCTION update_mode_rating();
diff --git a/supabase/migrations/003_add_rls_policies.sql b/supabase/migrations/003_add_rls_policies.sql
new file mode 100644
index 0000000..c8b3bc8
--- /dev/null
+++ b/supabase/migrations/003_add_rls_policies.sql
@@ -0,0 +1,210 @@
+-- Migration: 003_add_rls_policies.sql
+-- Description: Row Level Security policies for modes, likes, ratings, and versions
+-- Created: 2025-10-08
+
+-- Enable RLS on all tables
+ALTER TABLE modes ENABLE ROW LEVEL SECURITY;
+ALTER TABLE mode_likes ENABLE ROW LEVEL SECURITY;
+ALTER TABLE mode_ratings ENABLE ROW LEVEL SECURITY;
+ALTER TABLE mode_versions ENABLE ROW LEVEL SECURITY;
+
+-- ============================================================================
+-- MODES TABLE POLICIES
+-- ============================================================================
+
+-- Policy: Anyone can view public modes
+CREATE POLICY "Public modes are viewable by everyone"
+  ON modes FOR SELECT
+  USING (is_public = true);
+
+COMMENT ON POLICY "Public modes are viewable by everyone" ON modes IS
+  'Allows unauthenticated and authenticated users to view modes marked as public';
+
+-- Policy: Users can view their own modes (public or private)
+CREATE POLICY "Users can view own modes"
+  ON modes FOR SELECT
+  USING (auth.uid() = author_id);
+
+COMMENT ON POLICY "Users can view own modes" ON modes IS
+  'Allows users to view all their own modes regardless of public status';
+
+-- Policy: Users can create modes (author_id must match auth.uid())
+CREATE POLICY "Users can create modes"
+  ON modes FOR INSERT
+  WITH CHECK (auth.uid() = author_id);
+
+COMMENT ON POLICY "Users can create modes" ON modes IS
+  'Ensures users can only create modes with themselves as the author';
+
+-- Policy: Users can update their own modes
+CREATE POLICY "Users can update own modes"
+  ON modes FOR UPDATE
+  USING (auth.uid() = author_id)
+  WITH CHECK (auth.uid() = author_id);
+
+COMMENT ON POLICY "Users can update own modes" ON modes IS
+  'Allows users to update only their own modes and prevents changing author_id';
+
+-- Policy: Users can delete their own modes
+CREATE POLICY "Users can delete own modes"
+  ON modes FOR DELETE
+  USING (auth.uid() = author_id);
+
+COMMENT ON POLICY "Users can delete own modes" ON modes IS
+  'Allows users to delete only their own modes';
+
+-- Policy: Admins have full access (requires custom JWT claims)
+CREATE POLICY "Admins have full access to modes"
+  ON modes
+  USING (
+    (auth.jwt() ->> 'user_role')::text = 'admin'
+  );
+
+COMMENT ON POLICY "Admins have full access to modes" ON modes IS
+  'Grants full CRUD access to users with admin role in JWT claims';
+
+-- ============================================================================
+-- MODE_LIKES TABLE POLICIES
+-- ============================================================================
+
+-- Policy: Anyone can view likes on public modes
+CREATE POLICY "Public mode likes are viewable"
+  ON mode_likes FOR SELECT
+  USING (
+    EXISTS (
+      SELECT 1 FROM modes
+      WHERE modes.id = mode_likes.mode_id
+      AND modes.is_public = true
+    )
+  );
+
+COMMENT ON POLICY "Public mode likes are viewable" ON mode_likes IS
+  'Allows viewing likes for public modes only';
+
+-- Policy: Users can view their own likes
+CREATE POLICY "Users can view own likes"
+  ON mode_likes FOR SELECT
+  USING (auth.uid() = user_id);
+
+COMMENT ON POLICY "Users can view own likes" ON mode_likes IS
+  'Allows users to see which modes they have liked';
+
+-- Policy: Authenticated users can like public modes
+CREATE POLICY "Authenticated users can like modes"
+  ON mode_likes FOR INSERT
+  WITH CHECK (
+    auth.uid() = user_id
+    AND EXISTS (
+      SELECT 1 FROM modes
+      WHERE modes.id = mode_likes.mode_id
+      AND modes.is_public = true
+    )
+  );
+
+COMMENT ON POLICY "Authenticated users can like modes" ON mode_likes IS
+  'Allows authenticated users to like public modes only';
+
+-- Policy: Users can unlike modes they liked
+CREATE POLICY "Users can unlike modes"
+  ON mode_likes FOR DELETE
+  USING (auth.uid() = user_id);
+
+COMMENT ON POLICY "Users can unlike modes" ON mode_likes IS
+  'Allows users to remove their own likes';
+
+-- ============================================================================
+-- MODE_RATINGS TABLE POLICIES
+-- ============================================================================
+
+-- Policy: Anyone can view ratings on public modes
+CREATE POLICY "Public mode ratings are viewable"
+  ON mode_ratings FOR SELECT
+  USING (
+    EXISTS (
+      SELECT 1 FROM modes
+      WHERE modes.id = mode_ratings.mode_id
+      AND modes.is_public = true
+    )
+  );
+
+COMMENT ON POLICY "Public mode ratings are viewable" ON mode_ratings IS
+  'Allows viewing ratings and reviews for public modes';
+
+-- Policy: Users can view their own ratings
+CREATE POLICY "Users can view own ratings"
+  ON mode_ratings FOR SELECT
+  USING (auth.uid() = user_id);
+
+COMMENT ON POLICY "Users can view own ratings" ON mode_ratings IS
+  'Allows users to see their own ratings and reviews';
+
+-- Policy: Authenticated users can rate public modes
+CREATE POLICY "Authenticated users can rate modes"
+  ON mode_ratings FOR INSERT
+  WITH CHECK (
+    auth.uid() = user_id
+    AND EXISTS (
+      SELECT 1 FROM modes
+      WHERE modes.id = mode_ratings.mode_id
+      AND modes.is_public = true
+    )
+  );
+
+COMMENT ON POLICY "Authenticated users can rate modes" ON mode_ratings IS
+  'Allows authenticated users to rate and review public modes';
+
+-- Policy: Users can update their own ratings
+CREATE POLICY "Users can update own ratings"
+  ON mode_ratings FOR UPDATE
+  USING (auth.uid() = user_id)
+  WITH CHECK (auth.uid() = user_id);
+
+COMMENT ON POLICY "Users can update own ratings" ON mode_ratings IS
+  'Allows users to modify their existing ratings and reviews';
+
+-- Policy: Users can delete their own ratings
+CREATE POLICY "Users can delete own ratings"
+  ON mode_ratings FOR DELETE
+  USING (auth.uid() = user_id);
+
+COMMENT ON POLICY "Users can delete own ratings" ON mode_ratings IS
+  'Allows users to remove their ratings and reviews';
+
+-- ============================================================================
+-- MODE_VERSIONS TABLE POLICIES
+-- ============================================================================
+
+-- Policy: Users can view versions of modes they can access
+CREATE POLICY "Users can view accessible mode versions"
+  ON mode_versions FOR SELECT
+  USING (
+    EXISTS (
+      SELECT 1 FROM modes
+      WHERE modes.id = mode_versions.mode_id
+      AND (modes.is_public = true OR modes.author_id = auth.uid())
+    )
+  );
+
+COMMENT ON POLICY "Users can view accessible mode versions" ON mode_versions IS
+  'Allows viewing version history for public modes or user''s own modes';
+
+-- Policy: Only mode authors can create versions
+CREATE POLICY "Authors can create mode versions"
+  ON mode_versions FOR INSERT
+  WITH CHECK (
+    EXISTS (
+      SELECT 1 FROM modes
+      WHERE modes.id = mode_versions.mode_id
+      AND modes.author_id = auth.uid()
+    )
+  );
+
+COMMENT ON POLICY "Authors can create mode versions" ON mode_versions IS
+  'Allows only mode authors to create version history entries';
+
+-- ============================================================================
+-- CATEGORIES TABLE
+-- ============================================================================
+-- Categories are public (read-only for all users)
+-- No RLS needed - all users can read, only admins can modify via Supabase dashboard
+-- Not enabling RLS on categories table as it's meant to be fully public
diff --git a/supabase/migrations/004_add_indexes.sql b/supabase/migrations/004_add_indexes.sql
new file mode 100644
index 0000000..f1366f3
--- /dev/null
+++ b/supabase/migrations/004_add_indexes.sql
@@ -0,0 +1,187 @@
+-- Migration: 004_add_indexes.sql
+-- Description: Performance indexes for common query patterns
+-- Created: 2025-10-08
+
+-- ============================================================================
+-- MODES TABLE INDEXES
+-- ============================================================================
+
+-- Index: Lookup modes by author (user's library)
+CREATE INDEX IF NOT EXISTS idx_modes_author
+  ON modes(author_id);
+
+COMMENT ON INDEX idx_modes_author IS
+  'Optimizes queries for user''s own modes (library page)';
+
+-- Index: Filter public modes (catalog browsing)
+CREATE INDEX IF NOT EXISTS idx_modes_public
+  ON modes(is_public)
+  WHERE is_public = true;
+
+COMMENT ON INDEX idx_modes_public IS
+  'Partial index for efficient public mode filtering';
+
+-- Index: Featured modes (homepage, promotions)
+CREATE INDEX IF NOT EXISTS idx_modes_featured
+  ON modes(is_featured)
+  WHERE is_featured = true;
+
+COMMENT ON INDEX idx_modes_featured IS
+  'Partial index for featured modes display';
+
+-- Index: Filter by category
+CREATE INDEX IF NOT EXISTS idx_modes_category
+  ON modes(category);
+
+COMMENT ON INDEX idx_modes_category IS
+  'Optimizes category filtering in catalog';
+
+-- Index: Filter by tags (array contains queries)
+CREATE INDEX IF NOT EXISTS idx_modes_tags
+  ON modes USING GIN(tags);
+
+COMMENT ON INDEX idx_modes_tags IS
+  'GIN index for efficient tag-based filtering and search';
+
+-- Index: Sort by creation date (most recent first)
+CREATE INDEX IF NOT EXISTS idx_modes_created
+  ON modes(created_at DESC);
+
+COMMENT ON INDEX idx_modes_created IS
+  'Optimizes sorting by newest modes';
+
+-- Index: Sort by downloads (most popular)
+CREATE INDEX IF NOT EXISTS idx_modes_downloads
+  ON modes(downloads DESC);
+
+COMMENT ON INDEX idx_modes_downloads IS
+  'Optimizes sorting by download count';
+
+-- Index: Sort by likes (community favorites)
+CREATE INDEX IF NOT EXISTS idx_modes_likes
+  ON modes(likes DESC);
+
+COMMENT ON INDEX idx_modes_likes IS
+  'Optimizes sorting by like count';
+
+-- Index: Sort by rating (highest rated)
+CREATE INDEX IF NOT EXISTS idx_modes_rating
+  ON modes(rating DESC NULLS LAST);
+
+COMMENT ON INDEX idx_modes_rating IS
+  'Optimizes sorting by rating, placing unrated modes last';
+
+-- Index: Full-text search on name and description
+CREATE INDEX IF NOT EXISTS idx_modes_search
+  ON modes USING GIN(
+    to_tsvector('english', name || ' ' || COALESCE(description, ''))
+  );
+
+COMMENT ON INDEX idx_modes_search IS
+  'Full-text search index for mode name and description';
+
+-- Composite index: Public modes sorted by creation date
+CREATE INDEX IF NOT EXISTS idx_modes_public_created
+  ON modes(is_public, created_at DESC)
+  WHERE is_public = true;
+
+COMMENT ON INDEX idx_modes_public_created IS
+  'Optimizes catalog browsing with default sort';
+
+-- Composite index: Public modes by category and creation date
+CREATE INDEX IF NOT EXISTS idx_modes_public_category_created
+  ON modes(is_public, category, created_at DESC)
+  WHERE is_public = true;
+
+COMMENT ON INDEX idx_modes_public_category_created IS
+  'Optimizes filtered catalog browsing by category';
+
+-- ============================================================================
+-- MODE_LIKES TABLE INDEXES
+-- ============================================================================
+
+-- Index: Lookup likes by mode (for displaying like counts)
+CREATE INDEX IF NOT EXISTS idx_mode_likes_mode
+  ON mode_likes(mode_id);
+
+COMMENT ON INDEX idx_mode_likes_mode IS
+  'Optimizes counting likes for a specific mode';
+
+-- Index: Lookup likes by user (user's liked modes)
+CREATE INDEX IF NOT EXISTS idx_mode_likes_user
+  ON mode_likes(user_id);
+
+COMMENT ON INDEX idx_mode_likes_user IS
+  'Optimizes queries for modes liked by a specific user';
+
+-- Composite index: Check if user liked a specific mode
+CREATE INDEX IF NOT EXISTS idx_mode_likes_user_mode
+  ON mode_likes(user_id, mode_id);
+
+COMMENT ON INDEX idx_mode_likes_user_mode IS
+  'Optimizes checking if a specific user liked a specific mode';
+
+-- ============================================================================
+-- MODE_RATINGS TABLE INDEXES
+-- ============================================================================
+
+-- Index: Lookup ratings by mode (for calculating averages)
+CREATE INDEX IF NOT EXISTS idx_mode_ratings_mode
+  ON mode_ratings(mode_id);
+
+COMMENT ON INDEX idx_mode_ratings_mode IS
+  'Optimizes aggregating ratings for a specific mode';
+
+-- Index: Lookup ratings by user (user's rating history)
+CREATE INDEX IF NOT EXISTS idx_mode_ratings_user
+  ON mode_ratings(user_id);
+
+COMMENT ON INDEX idx_mode_ratings_user IS
+  'Optimizes queries for ratings by a specific user';
+
+-- Composite index: Recent ratings (for activity feeds)
+CREATE INDEX IF NOT EXISTS idx_mode_ratings_created
+  ON mode_ratings(mode_id, created_at DESC);
+
+COMMENT ON INDEX idx_mode_ratings_created IS
+  'Optimizes displaying recent ratings for a mode';
+
+-- ============================================================================
+-- MODE_VERSIONS TABLE INDEXES
+-- ============================================================================
+
+-- Index: Lookup versions by mode (version history)
+CREATE INDEX IF NOT EXISTS idx_mode_versions_mode
+  ON mode_versions(mode_id, created_at DESC);
+
+COMMENT ON INDEX idx_mode_versions_mode IS
+  'Optimizes retrieving version history for a mode';
+
+-- Index: Lookup specific version
+CREATE INDEX IF NOT EXISTS idx_mode_versions_mode_version
+  ON mode_versions(mode_id, version);
+
+COMMENT ON INDEX idx_mode_versions_mode_version IS
+  'Optimizes retrieving a specific version of a mode';
+
+-- ============================================================================
+-- CATEGORIES TABLE INDEXES
+-- ============================================================================
+
+-- Index: Order categories by display order
+CREATE INDEX IF NOT EXISTS idx_categories_display_order
+  ON categories(display_order);
+
+COMMENT ON INDEX idx_categories_display_order IS
+  'Optimizes ordering categories for display';
+
+-- ============================================================================
+-- ANALYZE TABLES FOR QUERY PLANNER
+-- ============================================================================
+
+-- Update statistics for query planner optimization
+ANALYZE modes;
+ANALYZE mode_likes;
+ANALYZE mode_ratings;
+ANALYZE mode_versions;
+ANALYZE categories;


---

_**Agent (claude-sonnet-4-5-20250929)**_

```
fix(library): correct editor routes and refine cloud mode save API
```

